<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="icono.png">
    <link rel="stylesheet" href="css/crear_horarios.css">

    <title>Crear Horario - Salas USM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>

<div class="topbar">
    <a href="index.html" class="logo">Salas USM</a>
    <a href="index.html" class="btn-nav">← Volver al menú</a>
</div>

<div class="container">

    <div class="left-panel">
        <h2>Buscar Asignatura</h2>
        <div class="search-area">
            <input type="text" id="buscar" placeholder="Sigla (ej: MAT021)...">
            <button class="clear-input-btn" id="limpiar" title="Borrar búsqueda">✕</button>
        </div>
        <div id="resultados">
            <p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">
                Escribe una sigla para buscar.
            </p>
        </div>

        <div class="added-subjects-container">
            <h3>Mis Ramos</h3>
            <div id="lista-mis-ramos">
                <p class="empty-msg">No has agregado ramos.</p>
            </div>
        </div>
    </div>

    <div class="right-panel">
        <div class="schedule-controls">
            <h2>Tu Horario</h2>
            <div class="btn-group">
                <button id="btn-descargar">Descargar Horario</button>
                <button id="btn-limpiar-horario">Limpiar</button>
            </div>
        </div>

        <div class="table-container" id="captura-horario">
            <table>
                <thead>
                    <tr>
                        <th>Bloque</th>
                        <th>Lunes</th>
                        <th>Martes</th>
                        <th>Miércoles</th>
                        <th>Jueves</th>
                        <th>Viernes</th>
                    </tr>
                </thead>
                <tbody id="tabla"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- 1. GENERAR TABLA ---
    const bloques = ["1-2","3-4","5-6","7-8","9-10","11-12","13-14","15-16"];
    const tbody = document.getElementById("tabla");

    bloques.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b}</td>
            <td class="cell" data-dia="Lunes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Martes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Miércoles" data-bloque="${b}"></td>
            <td class="cell" data-dia="Jueves" data-bloque="${b}"></td>
            <td class="cell" data-dia="Viernes" data-bloque="${b}"></td>
        `;
        tbody.appendChild(tr);
    });

    // --- 2. CARGA DE DATOS ---
    let datos = [];
    let ramosUnicos = [];
    let ramosEnHorario = new Set();

    fetch("data/salas.json")
        .then(r => r.json())
        .then(json => {
            datos = json;
            const mapa = new Map();
            json.forEach(r => {
                const clave = r.SIGLA + "-" + r.PARALELO;
                if (!mapa.has(clave)) mapa.set(clave, r);
            });
            ramosUnicos = Array.from(mapa.values());
        })
        .catch(err => console.error("Error cargando JSON:", err));

    function horaABloque(hora) {
        if(!hora) return null;
        const inicio = hora.split("-")[0];
        const h = parseInt(inicio.split(":")[0], 10);

        if (h < 9) return "1-2";
        if (h < 11) return "3-4";
        if (h < 13) return "5-6";
        if (h < 15) return "7-8";
        if (h < 17) return "9-10";
        if (h < 19) return "11-12";
        if (h < 21) return "13-14";
        return "15-16";
    }

    // --- 3. LÓGICA DE BÚSQUEDA ---
    const input = document.getElementById("buscar");
    const limpiarBtn = document.getElementById("limpiar");
    const resultadosDiv = document.getElementById("resultados");

    limpiarBtn.onclick = () => {
        input.value = "";
        resultadosDiv.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">Escribe una sigla para buscar.</p>';
    };

    input.addEventListener("input", () => {
        const q = input.value.toLowerCase().trim();
        resultadosDiv.innerHTML = "";

        if (q.length < 2) return;

        const filtrados = ramosUnicos.filter(r =>
            r.SIGLA.toLowerCase().includes(q)
        );

        if (filtrados.length === 0) {
            resultadosDiv.innerHTML = '<p style="color: #666; text-align: center;">No encontrado.</p>';
            return;
        }

        filtrados.forEach(r => {
            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `
                <div style="margin-bottom:5px;">
                    <strong style="color:white; font-size:1.1em;">${r.SIGLA}</strong> 
                    <span style="color:#aaa;">- P ${r.PARALELO}</span>
                </div>
                <div style="color:#ccc; margin-bottom:8px;">${r.NOMBRE}</div>
                <div style="font-size:0.9em; color:#888;">${r.PROFESOR || "Sin profesor"}</div>
                <button class="add-btn" data-sigla="${r.SIGLA}" data-paralelo="${r.PARALELO}">
                    + Añadir
                </button>
            `;
            resultadosDiv.appendChild(div);
        });
    });

    // --- 4. AÑADIR RAMO AL HORARIO ---
    let misRamosDetalle = [];
    
    document.addEventListener("click", e => {
        if (!e.target.classList.contains("add-btn")) return;

        const sigla = e.target.dataset.sigla;
        const paralelo = e.target.dataset.paralelo;
        const clave = sigla + "-" + paralelo;

        if (ramosEnHorario.has(clave)) {
            alert("⚠️ Este ramo ya está en tu horario.");
            return;
        }

        ramosEnHorario.add(clave);

        // Guardar detalle para la lista lateral
        const cursoInfo = datos.find(r => r.SIGLA === sigla && r.PARALELO === paralelo);
        misRamosDetalle.push({
            clave: clave,
            sigla: sigla,
            paralelo: paralelo,
            nombre: cursoInfo ? cursoInfo.NOMBRE : "Desconocido"
        });
        
        actualizarListaLateral();

        // Dibujar en el horario
        const cursos = datos.filter(r => r.SIGLA === sigla && r.PARALELO === paralelo);

        cursos.forEach(r => {
            const bloque = horaABloque(r.HORA);
            if(!bloque) return;

            const celda = document.querySelector(
                `td[data-dia="${r.DIA}"][data-bloque="${bloque}"]`
            );

            if (celda) {
                const tag = document.createElement("div");
                tag.className = "ramo";
                // IMPORTANTE: Esto permite identificar el bloque para borrarlo después
                tag.setAttribute("data-clave", clave); 
                tag.innerHTML = `<strong>${r.SIGLA}</strong><br><small>Sala ${r.SALA}</small>`;
                celda.appendChild(tag);
            }
        });
    });

    // --- 5. ACTUALIZAR LISTA LATERAL & BORRAR ---
    function actualizarListaLateral() {
        const contenedor = document.getElementById("lista-mis-ramos");
        contenedor.innerHTML = "";

        if (misRamosDetalle.length === 0) {
            contenedor.innerHTML = '<p class="empty-msg">No hay ramos agregados.</p>';
            return;
        }

        misRamosDetalle.forEach(item => {
            const div = document.createElement("div");
            div.className = "added-item";
            // Aquí cambiamos el icono por el texto "Eliminar" y aplicamos un estilo inline básico para el texto
            div.innerHTML = `
                <div style="flex: 1;">
                    <strong>${item.sigla}</strong> <small>(P${item.paralelo})</small>
                </div>
                <button class="btn-delete-ramo" onclick="eliminarRamo('${item.clave}')" title="Eliminar del horario" style="font-size: 12px; font-weight: bold;">
                    Eliminar
                </button>
            `;
            contenedor.appendChild(div);
        });
    }

    // Función Global para eliminar
    window.eliminarRamo = function(clave) {
        // 1. Borrar de la lógica
        ramosEnHorario.delete(clave);
        misRamosDetalle = misRamosDetalle.filter(r => r.clave !== clave);

        // 2. Borrar visualmente del horario (lado derecho)
        // Busca todos los div.ramo que tengan el data-clave correspondiente
        const bloquesVisuales = document.querySelectorAll(`.ramo[data-clave="${clave}"]`);
        bloquesVisuales.forEach(el => el.remove());

        // 3. Actualizar la lista lateral
        actualizarListaLateral();
    };

    // --- 6. LIMPIAR TODO ---
    document.getElementById("btn-limpiar-horario").onclick = () => {
        if(confirm("¿Borrar todo el horario?")) {
            // Limpia celdas visuales
            document.querySelectorAll(".cell").forEach(c => c.innerHTML = "");
            // Limpia datos lógicos
            ramosEnHorario.clear();
            misRamosDetalle = []; 
            // Limpia lista lateral
            actualizarListaLateral(); 
        }
    };

    // --- 7. DESCARGAR IMAGEN ---
    document.getElementById("btn-descargar").onclick = () => {
        const elementoParaCapturar = document.getElementById("captura-horario");
        const btn = document.getElementById("btn-descargar");
        const originalOverflow = elementoParaCapturar.style.overflow;
        const originalMaxWidth = elementoParaCapturar.style.maxWidth;
        const originalWidth = elementoParaCapturar.style.width;
        const textoOriginal = btn.innerText;

        elementoParaCapturar.style.overflow = "visible"; 
        elementoParaCapturar.style.maxWidth = "none";
        elementoParaCapturar.style.width = "fit-content"; 
        
        btn.innerText = "Generando...";
        setTimeout(() => {
            html2canvas(elementoParaCapturar, {
                backgroundColor: "#1e1e1e",
                scale: 2,
                width: elementoParaCapturar.scrollWidth,
                height: elementoParaCapturar.scrollHeight,
                windowWidth: elementoParaCapturar.scrollWidth,
                windowHeight: elementoParaCapturar.scrollHeight,
                x: 0,
                y: 0
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'horario_usm.png';
                link.href = canvas.toDataURL("image/png");
                link.click();

                elementoParaCapturar.style.overflow = originalOverflow;
                elementoParaCapturar.style.maxWidth = originalMaxWidth;
                elementoParaCapturar.style.width = originalWidth;
                btn.innerText = textoOriginal;
            }).catch(err => {
                console.error("Error al capturar:", err);
                elementoParaCapturar.style.overflow = originalOverflow;
                elementoParaCapturar.style.maxWidth = originalMaxWidth;
                elementoParaCapturar.style.width = originalWidth;
                btn.innerText = textoOriginal;
            });
        }, 100);
    };
</script>

</body>
</html>