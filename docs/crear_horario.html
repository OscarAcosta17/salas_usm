<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Crear Horario - Salas USM</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: #f4f6f7;
        }

        /* Barra superior */
        .topbar {
            background: #2c3e50;
            color: white;
            padding: 15px 25px;
            font-size: 22px;
        }

        .topbar a {
            color: white;
            text-decoration: none;
        }

        /* Contenedor principal */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        /* Panel izquierdo - búsqueda */
        .left-panel {
            width: 28%;
            min-width: 280px;
            border-right: 2px solid #ddd;
            padding: 20px;
            background: white;
            overflow-y: auto;
        }

        .search-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .search-area input {
            flex: 1;
            padding: 8px;
            font-size: 15px;
        }

        .clear-input-btn {
            padding: 8px 11px;
            background: #e74c3c;
            border: none;
            color: white;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        .result-item {
            background: #ecf0f1;
            padding: 12px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .add-btn {
            margin-top: 8px;
            padding: 5px 12px;
            background: #3498db;
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        /* Panel derecho - horario */
        .right-panel {
            width: 72%;
            padding: 20px;
            overflow-y: auto;
        }

        #btn-limpiar-horario {
            margin-bottom: 12px;
            padding: 8px 14px;
            background: #c0392b;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #btn-limpiar-horario:hover {
            background: #a93226;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            border: 1px solid #bbb;
            padding: 10px;
            text-align: center;
            vertical-align: middle;
        }

        th {
            background: #3498db;
            color: white;
        }

        .cell {
            height: 45px;
        }

        .ramo {
            background: #f9e79f;
            padding: 3px 5px;
            border-radius: 4px;
            display: block;
            margin: 2px;
            font-size: 13px;
        }
    </style>
</head>

<body>

<!-- Barra superior -->
<div class="topbar">
    <a href="index.html">Salas USM</a>
</div>

<div class="container">

    <!-- Panel izquierdo -->
    <div class="left-panel">

        <h2>Buscar ramo por sigla</h2>

        <div class="search-area">
            <input type="text" id="buscar" placeholder="Ej: MAT201, ELI328">
            <button class="clear-input-btn" id="limpiar">X</button>
        </div>

        <div id="resultados"></div>
    </div>

    <!-- Panel derecho -->
    <div class="right-panel">

        <h2>Horario Semanal</h2>

        <button id="btn-limpiar-horario">Limpiar horario</button>

        <table>
            <thead>
                <tr>
                    <th>Bloque</th>
                    <th>Lunes</th>
                    <th>Martes</th>
                    <th>Miércoles</th>
                    <th>Jueves</th>
                    <th>Viernes</th>
                </tr>
            </thead>
            <tbody id="tabla"></tbody>
        </table>

    </div>

</div>

<script>
    // ============================================
    // GENERAR TABLA DE BLOQUES
    // ============================================
    const bloques = ["1-2","3-4","5-6","7-8","9-10","11-12","13-14","15-16"];
    const tbody = document.getElementById("tabla");

    bloques.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><b>${b}</b></td>
            <td class="cell" data-dia="Lunes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Martes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Miércoles" data-bloque="${b}"></td>
            <td class="cell" data-dia="Jueves" data-bloque="${b}"></td>
            <td class="cell" data-dia="Viernes" data-bloque="${b}"></td>
        `;
        tbody.appendChild(tr);
    });

    // ============================================
    // VARIABLES GLOBALES
    // ============================================
    let datos = [];
    let ramosUnicos = [];
    let ramosEnHorario = new Set();

    // ============================================
    // CARGAR JSON
    // ============================================
    fetch("/salas_usm/data/salas.json")
        .then(r => r.json())
        .then(json => {
            datos = json;

            const mapa = new Map();
            json.forEach(r => {
                const clave = r.SIGLA + "-" + r.PARALELO;
                if (!mapa.has(clave)) mapa.set(clave, r);
            });
            ramosUnicos = Array.from(mapa.values());
        });

    // ============================================
    // MAPEAR HORA → BLOQUE
    // ============================================
    function horaABloque(hora) {
        const inicio = hora.split("-")[0];
        const h = parseInt(inicio.split(":")[0], 10);

        if (h < 9) return "1-2";
        if (h < 11) return "3-4";
        if (h < 13) return "5-6";
        if (h < 15) return "7-8";
        if (h < 17) return "9-10";
        if (h < 19) return "11-12";
        if (h < 21) return "13-14";
        return "15-16";
    }

    // ============================================
    // BUSQUEDA DE RAMOS
    // ============================================
    const input = document.getElementById("buscar");
    const limpiarBtn = document.getElementById("limpiar");
    const resultadosDiv = document.getElementById("resultados");

    limpiarBtn.onclick = () => {
        input.value = "";
        resultadosDiv.innerHTML = "";
    };

    input.addEventListener("input", () => {
        const q = input.value.toLowerCase();
        resultadosDiv.innerHTML = "";

        if (q.length < 2) return;

        const filtrados = ramosUnicos.filter(r =>
            r.SIGLA.toLowerCase().includes(q)
        );

        filtrados.forEach(r => {
            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `
                <b>${r.SIGLA}</b> - ${r.NOMBRE}<br>
                Profesor: ${r.PROFESOR}<br>
                Paralelo: ${r.PARALELO}<br>
                <button class="add-btn" data-sigla="${r.SIGLA}" data-paralelo="${r.PARALELO}">
                    Añadir al horario
                </button>
            `;
            resultadosDiv.appendChild(div);
        });
    });

    // ============================================
    // AÑADIR AL HORARIO (con control de duplicados)
    // ============================================
    document.addEventListener("click", e => {
        if (!e.target.classList.contains("add-btn")) return;

        const sigla = e.target.dataset.sigla;
        const paralelo = e.target.dataset.paralelo;
        const clave = sigla + "-" + paralelo;

        if (ramosEnHorario.has(clave)) {
            alert("Este ramo ya fue añadido al horario.");
            return;
        }

        ramosEnHorario.add(clave);

        const cursos = datos.filter(r => r.SIGLA === sigla && r.PARALELO === paralelo);

        cursos.forEach(r => {
            const bloque = horaABloque(r.HORA);
            const celda = document.querySelector(
                `td[data-dia="${r.DIA}"][data-bloque="${bloque}"]`
            );

            if (celda) {
                const tag = document.createElement("span");
                tag.className = "ramo";
                tag.textContent = `${r.SIGLA} (${r.SALA})`;
                celda.appendChild(tag);
            }
        });
    });

    // ============================================
    // LIMPIAR HORARIO COMPLETO
    // ============================================
    document.getElementById("btn-limpiar-horario").onclick = () => {
        document.querySelectorAll(".cell").forEach(c => c.innerHTML = "");
        ramosEnHorario.clear();
    };
</script>

</body>
</html>
