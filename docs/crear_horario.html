<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="icono.png">
    <link rel="stylesheet" href="css/crear_horarios.css">

    <title>Crear Horario - Salas USM</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


</head>

<body>

<div class="topbar">
    <a href="index.html" class="logo">Salas USM</a>
    <a href="index.html" class="btn-nav">← Volver al menú</a>
</div>

<div class="container">

    <div class="left-panel">
        <h2>Buscar Asignatura</h2>
        <div class="search-area">
            <input type="text" id="buscar" placeholder="Sigla (ej: MAT021)...">
            <button class="clear-input-btn" id="limpiar" title="Borrar búsqueda">✕</button>
        </div>
        <div id="resultados">
            <p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">
                Escribe una sigla para buscar.
            </p>
        </div>
    </div>

    <div class="right-panel">
        <div class="schedule-controls">
            <h2>Tu Horario</h2>
            <div class="btn-group">
                <button id="btn-descargar">Descargar Horario</button>
                <button id="btn-limpiar-horario">Limpiar</button>
            </div>
        </div>

        <div class="table-container" id="captura-horario">
            <table>
                <thead>
                    <tr>
                        <th>Bloque</th>
                        <th>Lunes</th>
                        <th>Martes</th>
                        <th>Miércoles</th>
                        <th>Jueves</th>
                        <th>Viernes</th>
                    </tr>
                </thead>
                <tbody id="tabla"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // ============================================
    // GENERAR TABLA
    // ============================================
    const bloques = ["1-2","3-4","5-6","7-8","9-10","11-12","13-14","15-16"];
    const tbody = document.getElementById("tabla");

    bloques.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b}</td>
            <td class="cell" data-dia="Lunes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Martes" data-bloque="${b}"></td>
            <td class="cell" data-dia="Miércoles" data-bloque="${b}"></td>
            <td class="cell" data-dia="Jueves" data-bloque="${b}"></td>
            <td class="cell" data-dia="Viernes" data-bloque="${b}"></td>
        `;
        tbody.appendChild(tr);
    });

    // ============================================
    // LOGICA DE DATOS
    // ============================================
    let datos = [];
    let ramosUnicos = [];
    let ramosEnHorario = new Set();

    fetch("data/salas.json")
        .then(r => r.json())
        .then(json => {
            datos = json;
            const mapa = new Map();
            json.forEach(r => {
                const clave = r.SIGLA + "-" + r.PARALELO;
                if (!mapa.has(clave)) mapa.set(clave, r);
            });
            ramosUnicos = Array.from(mapa.values());
        })
        .catch(err => console.error("Error cargando JSON:", err));

    function horaABloque(hora) {
        if(!hora) return null;
        const inicio = hora.split("-")[0];
        const h = parseInt(inicio.split(":")[0], 10);

        if (h < 9) return "1-2";
        if (h < 11) return "3-4";
        if (h < 13) return "5-6";
        if (h < 15) return "7-8";
        if (h < 17) return "9-10";
        if (h < 19) return "11-12";
        if (h < 21) return "13-14";
        return "15-16";
    }

    // ============================================
    // BUSQUEDA
    // ============================================
    const input = document.getElementById("buscar");
    const limpiarBtn = document.getElementById("limpiar");
    const resultadosDiv = document.getElementById("resultados");

    limpiarBtn.onclick = () => {
        input.value = "";
        resultadosDiv.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">Escribe una sigla para buscar.</p>';
    };

    input.addEventListener("input", () => {
        const q = input.value.toLowerCase().trim();
        resultadosDiv.innerHTML = "";

        if (q.length < 2) return;

        const filtrados = ramosUnicos.filter(r =>
            r.SIGLA.toLowerCase().includes(q)
        );

        if (filtrados.length === 0) {
            resultadosDiv.innerHTML = '<p style="color: #666; text-align: center;">No encontrado.</p>';
            return;
        }

        filtrados.forEach(r => {
            const div = document.createElement("div");
            div.className = "result-item";
            div.innerHTML = `
                <div style="margin-bottom:5px;">
                    <strong style="color:white; font-size:1.1em;">${r.SIGLA}</strong> 
                    <span style="color:#aaa;">- P ${r.PARALELO}</span>
                </div>
                <div style="color:#ccc; margin-bottom:8px;">${r.NOMBRE}</div>
                <div style="font-size:0.9em; color:#888;">${r.PROFESOR || "Sin profesor"}</div>
                <button class="add-btn" data-sigla="${r.SIGLA}" data-paralelo="${r.PARALELO}">
                    + Añadir
                </button>
            `;
            resultadosDiv.appendChild(div);
        });
    });

    // ============================================
    // AÑADIR
    // ============================================
    document.addEventListener("click", e => {
        if (!e.target.classList.contains("add-btn")) return;

        const sigla = e.target.dataset.sigla;
        const paralelo = e.target.dataset.paralelo;
        const clave = sigla + "-" + paralelo;

        if (ramosEnHorario.has(clave)) {
            alert("⚠️ Este ramo ya está en tu horario.");
            return;
        }

        ramosEnHorario.add(clave);

        const cursos = datos.filter(r => r.SIGLA === sigla && r.PARALELO === paralelo);

        cursos.forEach(r => {
            const bloque = horaABloque(r.HORA);
            if(!bloque) return;

            const celda = document.querySelector(
                `td[data-dia="${r.DIA}"][data-bloque="${bloque}"]`
            );

            if (celda) {
                const tag = document.createElement("div");
                tag.className = "ramo";
                tag.innerHTML = `<strong>${r.SIGLA}</strong><br><small>Sala ${r.SALA}</small>`;
                celda.appendChild(tag);
            }
        });
    });

    document.getElementById("btn-limpiar-horario").onclick = () => {
        if(confirm("¿Borrar todo el horario?")) {
            document.querySelectorAll(".cell").forEach(c => c.innerHTML = "");
            ramosEnHorario.clear();
        }
    };

    // ============================================
    // DESCARGAR IMAGEN (NUEVO)
    // ============================================
    document.getElementById("btn-descargar").onclick = () => {
        const elementoParaCapturar = document.getElementById("captura-horario");
        
        // Efecto visual de "cargando"
        const btn = document.getElementById("btn-descargar");
        const textoOriginal = btn.innerText;
        btn.innerText = "Generando...";

        html2canvas(elementoParaCapturar, {
            backgroundColor: "#1e1e1e", // Asegura que el fondo oscuro salga en la foto
            scale: 2 // Mejora la calidad (resolución) de la imagen
        }).then(canvas => {
            // Crear enlace temporal
            const link = document.createElement('a');
            link.download = 'horario_usm.png';
            link.href = canvas.toDataURL("image/png");
            link.click();

            // Restaurar texto del botón
            btn.innerText = textoOriginal;
        });
    };
</script>

</body>
</html>